############################
# é…ç½®
############################
$resourceGroup = "your-rg"
$galleryName   = "your-gallery"

$thresholdDate = (Get-Date).AddDays(-90)

$minKeep       = 2       # ğŸ‘ˆ å¯é…ç½®ï¼šæœ€å°‘ä¿ç•™å‡ ä¸ª
$dryRun        = $true   # å…ˆæµ‹è¯•

############################
# 1. è·å–æ‰€æœ‰ image version
############################
$images = az sig image-version list `
  -g $resourceGroup `
  -r $galleryName `
  --query "[].{name:name, id:id, definition:storageProfile.imageDefinitionId}" `
  -o json | ConvertFrom-Json

############################
# 2. æŒ‰ Image Definition åˆ†ç»„
############################
$grouped = $images | Group-Object definition

foreach ($group in $grouped) {

    Write-Host "`n======================================="
    Write-Host "Definition: $($group.Name)"
    Write-Host "Total versions: $($group.Count)"

    # è§£ææ—¥æœŸ
    $parsed = foreach ($img in $group.Group) {

        $digits = $img.name -replace '\D',''

        if ($digits.Length -lt 8) { continue }

        try {
            $imgDate = [datetime]::ParseExact(
                $digits.Substring(0,8),
                "yyyyMMdd",
                $null
            )

            [PSCustomObject]@{
                Name    = $img.name
                Id      = $img.id
                Date    = $imgDate
            }
        }
        catch {}
    }

    # æŒ‰æ—¥æœŸæ’åºï¼ˆæ–°â†’æ—§ï¼‰
    $sorted = $parsed | Sort-Object Date -Descending

    Write-Host "Valid parsed images: $($sorted.Count)"

    ############################
    # 3. ä¿ç•™ç­–ç•¥
    ############################

    # â‘  å…ˆä¿ç•™æœ€æ–° N ä¸ª
    $keep = $sorted | Select-Object -First $minKeep

    # â‘¡ å‰©ä½™çš„æ‰è€ƒè™‘90å¤©
    $candidates = $sorted | Select-Object -Skip $minKeep

    $toDelete = $candidates | Where-Object {
        $_.Date -lt $thresholdDate
    }

    ############################
    # 4. æ‰§è¡Œåˆ é™¤
    ############################

    foreach ($d in $toDelete) {

        Write-Host "Delete candidate: $($d.Name) date=$($d.Date)"

        if ($dryRun) {
            Write-Host "  [DRYRUN] would delete"
        }
        else {
            az sig image-version delete --ids $d.Id
            Write-Host "  Deleted"
        }
    }
}



-------------------------------------------------------
-----------------------------------------------
############################
# å®‰å…¨æ—¥æœŸè§£æå‡½æ•°
############################
function Convert-ImageDate($name) {

    $parts = $name -split '\.'
    if ($parts.Count -lt 3) { return $null }

    try {
        $yy = [int]$parts[0]
        $MM = [int]$parts[1]
        $dd = [int]($parts[2].Substring(0,2))
    }
    catch {
        return $null
    }

    $currentYear = (Get-Date).Year
    $century     = [math]::Floor($currentYear / 100) * 100

    $year = $century + $yy

    if ($year -gt ($currentYear + 2)) {
        $year -= 100
    }

    try {
        Get-Date -Year $year -Month $MM -Day $dd
    }
    catch {
        $null
    }
}

############################
# è§£æ
############################
$parsed = foreach ($img in $group.Group) {

    $imgDate = Convert-ImageDate $img.name

    if (-not $imgDate) {
        Write-Host "Skip invalid name: $($img.name)"
        continue
    }

    [PSCustomObject]@{
        Name = $img.name
        Id   = $img.id
        Date = $imgDate
    }
}
äº”ã€æˆ‘å¸®ä½ åšè‡ªåŠ¨æµ‹è¯•è„šæœ¬
ä½ æœ¬åœ°ç›´æ¥è·‘ï¼š

powershell
Copy code
$tests = @(
 "25.01.01220000",
 "24.12.31235959",
 "24.02.29220000",
 "23.02.29220000",
 "99.01.01220000",
 "00.01.01220000",
 "ab.xx.yy"
)

foreach ($t in $tests) {
    "$t => $(Convert-ImageDate $t)"
}











--------------------------------
20000
############################
# é…ç½®
############################
$resourceGroup = "your-rg"
$galleryName   = "your-gallery"

$thresholdDate = (Get-Date).AddDays(-90)

$minKeep       = 2
$dryRun        = $true

############################
# 1. è·å–æ‰€æœ‰ image version
############################
$images = az sig image-version list `
  -g $resourceGroup `
  -r $galleryName `
  --query "[].{name:name, id:id, definition:storageProfile.imageDefinitionId}" `
  -o json | ConvertFrom-Json

############################
# 2. æŒ‰ Definition åˆ†ç»„ï¼ˆLinux/Windowså¤©ç„¶åˆ†å¼€ï¼‰
############################
$grouped = $images | Group-Object definition

foreach ($group in $grouped) {

    Write-Host "`n===== Definition: $($group.Name) ====="
    Write-Host "Total versions: $($group.Count)"

    ############################
    # æ—¥æœŸè§£æï¼ˆé€‚é… 25.10.10224518ï¼‰
    ############################
    $parsed = foreach ($img in $group.Group) {

        try {
            $parts = $img.name -split '\.'

            if ($parts.Count -lt 3) { continue }

            $yy = [int]$parts[0]
            $MM = [int]$parts[1]
            $dd = [int]($parts[2].Substring(0,2))

            $year = 2000 + $yy

            $imgDate = Get-Date -Year $year -Month $MM -Day $dd

            [PSCustomObject]@{
                Name = $img.name
                Id   = $img.id
                Date = $imgDate
            }
        }
        catch {
            Write-Host "Skip invalid name: $($img.name)"
        }
    }

    $sorted = $parsed | Sort-Object Date -Descending

    Write-Host "Valid parsed: $($sorted.Count)"

    ############################
    # ä¿ç•™ç­–ç•¥
    ############################

    $keep = $sorted | Select-Object -First $minKeep

    $candidates = $sorted | Select-Object -Skip $minKeep

    $toDelete = $candidates | Where-Object {
        $_.Date -lt $thresholdDate
    }

    ############################
    # åˆ é™¤
    ############################
    foreach ($d in $toDelete) {

        Write-Host "Delete candidate: $($d.Name) date=$($d.Date)"

        if ($dryRun) {
            Write-Host "  [DRYRUN] would delete"
        }
        else {
            az sig image-version delete --ids $d.Id --yes
            Write-Host "  Deleted"
        }
    }
}
