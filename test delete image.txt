############################
# é…ç½®
############################
$resourceGroup = "your-rg"
$galleryName   = "your-gallery"

$thresholdDate = (Get-Date).AddDays(-90)

$minKeep       = 2       # ğŸ‘ˆ å¯é…ç½®ï¼šæœ€å°‘ä¿ç•™å‡ ä¸ª
$dryRun        = $true   # å…ˆæµ‹è¯•

############################
# 1. è·å–æ‰€æœ‰ image version
############################
$images = az sig image-version list `
  -g $resourceGroup `
  -r $galleryName `
  --query "[].{name:name, id:id, definition:storageProfile.imageDefinitionId}" `
  -o json | ConvertFrom-Json

############################
# 2. æŒ‰ Image Definition åˆ†ç»„
############################
$grouped = $images | Group-Object definition

foreach ($group in $grouped) {

    Write-Host "`n======================================="
    Write-Host "Definition: $($group.Name)"
    Write-Host "Total versions: $($group.Count)"

    # è§£ææ—¥æœŸ
    $parsed = foreach ($img in $group.Group) {

        $digits = $img.name -replace '\D',''

        if ($digits.Length -lt 8) { continue }

        try {
            $imgDate = [datetime]::ParseExact(
                $digits.Substring(0,8),
                "yyyyMMdd",
                $null
            )

            [PSCustomObject]@{
                Name    = $img.name
                Id      = $img.id
                Date    = $imgDate
            }
        }
        catch {}
    }

    # æŒ‰æ—¥æœŸæ’åºï¼ˆæ–°â†’æ—§ï¼‰
    $sorted = $parsed | Sort-Object Date -Descending

    Write-Host "Valid parsed images: $($sorted.Count)"

    ############################
    # 3. ä¿ç•™ç­–ç•¥
    ############################

    # â‘  å…ˆä¿ç•™æœ€æ–° N ä¸ª
    $keep = $sorted | Select-Object -First $minKeep

    # â‘¡ å‰©ä½™çš„æ‰è€ƒè™‘90å¤©
    $candidates = $sorted | Select-Object -Skip $minKeep

    $toDelete = $candidates | Where-Object {
        $_.Date -lt $thresholdDate
    }

    ############################
    # 4. æ‰§è¡Œåˆ é™¤
    ############################

    foreach ($d in $toDelete) {

        Write-Host "Delete candidate: $($d.Name) date=$($d.Date)"

        if ($dryRun) {
            Write-Host "  [DRYRUN] would delete"
        }
        else {
            az sig image-version delete --ids $d.Id
            Write-Host "  Deleted"
        }
    }
}
