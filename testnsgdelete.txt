æ ¸å¿ƒæ€è·¯ï¼š

tfvars é‡Œæ˜¯ä¸€ä¸ª map/listï¼Œå¸¦ end_date

locals é‡Œå…ˆåšâ€œè¿‡æ»¤â€

for_each åªå¯¹æœªè¿‡æœŸçš„ç”¨æˆ·ç”Ÿæ•ˆ

ä¸€ã€æŽ¨èæ•°æ®ç»“æž„ï¼ˆtfvarsï¼‰
terraform.tfvars
users = {
  userA = {
    end_date = "2025-03-01"
    location = "eastus"
  }

  userB = {
    end_date = "2024-12-01"
    location = "eastus"
  }

  userC = {
    end_date = "2026-01-01"
    location = "westeurope"
  }
}

äºŒã€variables.tf
variable "users" {
  type = map(object({
    end_date = string
    location = string
  }))
}

ä¸‰ã€æ ¸å¿ƒï¼šå…ˆè¿‡æ»¤â€œæœªè¿‡æœŸç”¨æˆ·â€
locals {

  today = formatdate("YYYY-MM-DD", timestamp())

  valid_users = {
    for k, v in var.users :
    k => v
    if local.today <= v.end_date
  }
}


ðŸ’¡ å…³é”®ç‚¹

å…ˆåœ¨ locals é‡Œè¿‡æ»¤

for_each åªç”¨ valid_users

å››ã€NSG for_each
resource "azurerm_network_security_group" "this" {

  for_each = local.valid_users

  name                = "${each.key}-nsg"
  location            = each.value.location
  resource_group_name = azurerm_resource_group.this.name

  security_rule {
    name                       = "allow-ssh"
    priority                   = 100
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "Tcp"
    destination_port_range     = "22"
    source_address_prefix      = "*"
    destination_address_prefix = "*"
  }

  tags = {
    owner    = each.key
    end_date = each.value.end_date
  }
}

äº”ã€æ•ˆæžœ

å‡è®¾ä»Šå¤©æ˜¯ï¼š

2025-01-10

ç”¨æˆ·	end_date	ç»“æžœ
userA 2025-03-01	âœ… åˆ›å»º	
userB 2024-12-01	âŒ ä¸åˆ›å»º	
userC 2026-01-01	âœ… åˆ›å»º	
å…­ã€è¿›é˜¶ï¼šé¡ºå¸¦å¤„ç† subnet ç»‘å®š

å¦‚æžœä½ è¿˜æœ‰ï¼š

resource "azurerm_subnet_network_security_group_association" "this" {
  for_each = local.valid_users

  subnet_id                 = azurerm_subnet.this[each.key].id
  network_security_group_id = azurerm_network_security_group.this[each.key].id
}


è¿‡æœŸç”¨æˆ· â†’ NSG å’Œç»‘å®šéƒ½ä¼šè‡ªåŠ¨æ¶ˆå¤±

ä¸ƒã€æ³¨æ„ç‚¹ï¼ˆéžå¸¸é‡è¦ï¼‰
1. Terraform è¡Œä¸º

åˆ°æœŸåŽï¼š

ä¸‹æ¬¡ apply

èµ„æºä¼šè¢« destroy

2. å¦‚æžœä½ â€œä¸æƒ³è‡ªåŠ¨åˆ å·²æœ‰â€

æ”¹æˆï¼š

valid_users = {
  for k, v in var.users :
  k => v
  if local.today <= v.end_date || contains(keys(azurerm_network_security_group.this), k)
}

å…«ã€æˆ‘å¸®ä½ æŒ‰ä½ çœŸå®žç»“æž„æ”¹

ä½ ä¹‹å‰é¡¹ç›®æœ‰ï¼š

windows / legacy_windows

subnet æ¡ä»¶åˆ›å»º

aa.auto.tfvars

ä½ å¯ä»¥æŠŠï¼š

ä½ çŽ°åœ¨çš„ users tfvars ç»“æž„

ä½ çœŸå®ž NSG resource

æ˜¯å¦è¿˜è¦ç»‘ subnet

è´´ç»™æˆ‘ï¼Œæˆ‘å¸®ä½ æ”¹æˆï¼š

âœ” å®Œå…¨è´´åˆä½ é¡¹ç›®
âœ” ä¸ç ´åå·²æœ‰èµ„æº
âœ” åˆ°æœŸè‡ªåŠ¨è·³è¿‡ ðŸ‘
