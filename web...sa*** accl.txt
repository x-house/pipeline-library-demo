æ ¸å¿ƒèµ„æºå…³ç³»

AWS WAFv2 ä½¿ç”¨èµ„æºï¼šaws_wafv2_web_acl

ALB èµ„æºï¼šaws_lb

å…³è”ï¼šaws_wafv2_web_acl_association

é‡ç‚¹ï¼š

ALB å¿…é¡»æ˜¯ application load balancer

WebACL çš„ scope å¿…é¡»æ˜¯ REGIONALï¼ˆCloudFront æ‰ç”¨ CLOUDFRONTï¼‰

äºŒã€æœ€å°å¯ç”¨ç¤ºä¾‹
1. åˆ›å»º WebACL
resource "aws_wafv2_web_acl" "example" {
  name  = "example-webacl"
  scope = "REGIONAL"

  default_action {
    allow {}
  }

  visibility_config {
    cloudwatch_metrics_enabled = true
    metric_name                = "exampleWebACL"
    sampled_requests_enabled   = true
  }

  rule {
    name     = "AWS-AWSManagedRulesCommonRuleSet"
    priority = 1

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        name        = "AWSManagedRulesCommonRuleSet"
        vendor_name = "AWS"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "commonRules"
      sampled_requests_enabled   = true
    }
  }
}

2. ALB ç¤ºä¾‹
resource "aws_lb" "example" {
  name               = "example-alb"
  load_balancer_type = "application"
  internal           = false

  subnets = [
    aws_subnet.public_a.id,
    aws_subnet.public_b.id
  ]

  security_groups = [aws_security_group.alb.id]
}

3. å…³è” WebACL åˆ° ALBï¼ˆæœ€å…³é”®ï¼‰
resource "aws_wafv2_web_acl_association" "example" {
  resource_arn = aws_lb.example.arn
  web_acl_arn  = aws_wafv2_web_acl.example.arn
}




==================================
å®Œæ•´ Terraformï¼ˆALB ç‰ˆï¼‰
1. waf.tf
############################
# 1. WebACL
############################
resource "aws_wafv2_web_acl" "this" {
  name  = "alb-common-webacl"
  scope = "REGIONAL"

  default_action {
    allow {}
  }

  visibility_config {
    cloudwatch_metrics_enabled = true
    metric_name                = "albCommonWebACL"
    sampled_requests_enabled   = true
  }

  ############################
  # 2. AWS æ‰˜ç®¡åŸºç¡€è§„åˆ™
  ############################
  rule {
    name     = "AWSManagedCommon"
    priority = 10

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        vendor_name = "AWS"
        name        = "AWSManagedRulesCommonRuleSet"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWSManagedCommon"
      sampled_requests_enabled   = true
    }
  }

  ############################
  # 3. SQL æ³¨å…¥ä¸“ç”¨
  ############################
  rule {
    name     = "AWSManagedSQLi"
    priority = 20

    override_action {
      none {}
    }

    statement {
      managed_rule_group_statement {
        vendor_name = "AWS"
        name        = "AWSManagedRulesSQLiRuleSet"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "AWSManagedSQLi"
      sampled_requests_enabled   = true
    }
  }

  ############################
  # 4. Rate Limit é˜² CC
  ############################
  rule {
    name     = "RateLimit"
    priority = 30

    action {
      block {}
    }

    statement {
      rate_based_statement {
        limit              = 2000   # æ¯5åˆ†é’Ÿ2000è¯·æ±‚
        aggregate_key_type = "IP"
      }
    }

    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "rateLimit"
      sampled_requests_enabled   = true
    }
  }
}

2. å…³è” ALB
resource "aws_wafv2_web_acl_association" "this" {
  resource_arn = aws_lb.this.arn
  web_acl_arn  = aws_wafv2_web_acl.this.arn
}



=================
ç›®æ ‡ï¼š

âœ… WAF æ—¥å¿— â†’ S3
âœ… è‡ªåŠ¨è¿‡æœŸåˆ é™¤ï¼ˆå¦‚ 30/90 å¤©ï¼‰
âœ… ç¬¦åˆ AWS è¦æ±‚ï¼šå¿…é¡»èµ° Firehose
âœ… æœ€å°æƒé™

ä¸€ã€å®Œæ•´ Terraformï¼ˆæ¨èç‰ˆï¼‰
1. S3 Bucket + ç”Ÿå‘½å‘¨æœŸ
#####################################
# S3 for WAF Logs
#####################################
resource "aws_s3_bucket" "waf_logs" {
  bucket = "aws-waf-logs-${data.aws_caller_identity.current.account_id}"
}

resource "aws_s3_bucket_lifecycle_configuration" "waf" {
  bucket = aws_s3_bucket.waf_logs.id

  rule {
    id     = "expire-waf-logs"
    status = "Enabled"

    expiration {
      days = 90          # ğŸ‘ˆ è¿™é‡Œæ”¹ä¿å­˜å¤©æ•°
    }

    noncurrent_version_expiration {
      noncurrent_days = 7
    }
  }
}

2. IAM Role ç»™ Firehose
#####################################
# IAM for Firehose
#####################################
resource "aws_iam_role" "firehose" {
  name = "waf-firehose-to-s3"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect = "Allow"
      Principal = {
        Service = "firehose.amazonaws.com"
      }
      Action = "sts:AssumeRole"
    }]
  })
}

resource "aws_iam_role_policy" "firehose" {
  role = aws_iam_role.firehose.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "s3:PutObject",
          "s3:PutObjectAcl"
        ]
        Resource = "${aws_s3_bucket.waf_logs.arn}/*"
      }
    ]
  })
}

3. Kinesis Firehoseï¼ˆâš  åå­—å¿…é¡» aws-waf-logs å¼€å¤´ï¼‰

è¿™æ˜¯ AWS å¼ºåˆ¶è¦æ±‚

#####################################
# Firehose
#####################################
resource "aws_kinesis_firehose_delivery_stream" "waf" {

  # â— å¿…é¡» aws-waf-logs- å¼€å¤´
  name        = "aws-waf-logs-alb"
  destination = "s3"

  s3_configuration {
    role_arn   = aws_iam_role.firehose.arn
    bucket_arn = aws_s3_bucket.waf_logs.arn

    buffering_size     = 5
    buffering_interval = 300
    compression_format = "GZIP"
  }
}

4. WebACL Loggingï¼ˆæ ¸å¿ƒï¼‰
#####################################
# Enable WAF Logging
#####################################
resource "aws_wafv2_web_acl_logging_configuration" "this" {

  resource_arn = aws_wafv2_web_acl.this.arn

  log_destination_configs = [
    aws_kinesis_firehose_delivery_stream.waf.arn
  ]

  # å®‰å…¨ï¼šè„±æ• token
  redacted_fields {
    single_header {
      name = "authorization"
    }
  }

  #####################################
  # åªè®°å½• BLOCK æ—¥å¿—ï¼ˆç”Ÿäº§æ¨èï¼‰
  #####################################
  logging_filter {
    default_behavior = "DROP"

    filter {
      behavior = "KEEP"

      condition {
        action_condition {
          action = "BLOCK"
        }
      }

      requirement = "MEETS_ANY"
    }
  }
}

äºŒã€æ•ˆæœ
1. S3 ç»“æ„
s3://aws-waf-logs-xxxx/
â””â”€â”€ AWSLogs/
    â””â”€â”€ account-id/
        â””â”€â”€ waf/

2. æ—¥å¿—èƒ½çœ‹åˆ°

æº IP

URI / Query

å‘½ä¸­å“ªæ¡ rule

BLOCK åŸå› 

headersï¼ˆå·²è„±æ•ï¼‰







===========================
Terraformï¼ˆS3 ç‰ˆæˆ‘å¸®ä½ ç²¾ç®€ä¸€ä»½ï¼‰
############################
# S3 + ç”Ÿå‘½å‘¨æœŸ
############################
resource "aws_s3_bucket" "waf" {
  bucket = "aws-waf-logs-${var.env}-${data.aws_caller_identity.current.account_id}"
}

resource "aws_s3_bucket_lifecycle_configuration" "waf" {
  bucket = aws_s3_bucket.waf.id

  rule {
    id     = "expire"
    status = "Enabled"

    expiration {
      days = var.env == "prod" ? 90 : 14
    }
  }
}

############################
# Firehoseï¼ˆå¿…é¡» aws-waf-logs-ï¼‰
############################
resource "aws_kinesis_firehose_delivery_stream" "waf" {
  name        = "aws-waf-logs-${var.env}"
  destination = "s3"

  s3_configuration {
    role_arn   = aws_iam_role.firehose.arn
    bucket_arn = aws_s3_bucket.waf.arn

    compression_format = "GZIP"
  }
}

############################
# å¼€å¯ WAF Logging
############################
resource "aws_wafv2_web_acl_logging_configuration" "this" {

  resource_arn = aws_wafv2_web_acl.this.arn

  log_destination_configs = [
    aws_kinesis_firehose_delivery_stream.waf.arn
  ]

  # è„±æ•
  redacted_fields {
    single_header {
      name = "authorization"
    }
  }

  # ç”Ÿäº§åªè®°å½• BLOCK
  logging_filter {
    default_behavior = var.env == "prod" ? "DROP" : "KEEP"

    filter {
      behavior = "KEEP"
      condition {
        action_condition {
          action = "BLOCK"
        }
      }
      requirement = "MEETS_ANY"
    }
  }
}


