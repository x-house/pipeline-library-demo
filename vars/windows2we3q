ä»¥ä¸‹æ˜¯é’ˆå¯¹æ‚¨éœ€æ±‚çš„ SlackHQ Nebula è¯¦ç»†é…ç½®æ–¹æ¡ˆï¼Œå®ç° EC2-A (10.11.2.1) é€šè¿‡ EC2-B (10.135.2.14) è®¿é—® EC2-C (10.101.2.4:3128)ï¼š

ä¸€ã€ç½‘ç»œæ‹“æ‰‘ä¸å‰ææ¡ä»¶
èŠ‚ç‚¹	ç§æœ‰IP	è§’è‰²	è®¿é—®å…³ç³»
EC2-A	10.11.2.1	å®¢æˆ·ç«¯	å¯ç›´è¿ EC2-Bï¼Œä¸å¯è¿ EC2-C
EC2-B	10.135.2.14	ä¸­ç»§èŠ‚ç‚¹	å¯ç›´è¿ EC2-C
EC2-C	10.101.2.4	æœåŠ¡ç«¯ï¼ˆ3128ç«¯å£ï¼‰	ä»…å…è®¸ EC2-B è®¿é—®
è¦æ±‚ï¼šæ‰€æœ‰èŠ‚ç‚¹å‡æ— å…¬ç½‘IPï¼Œéœ€é€šè¿‡ Nebula è™šæ‹Ÿç»„ç½‘ã€‚

äºŒã€Nebula é…ç½®æ­¥éª¤
1. ç”Ÿæˆè¯ä¹¦ï¼ˆåœ¨ Lighthouse æˆ–ç®¡ç†èŠ‚ç‚¹æ“ä½œï¼‰
bash
# ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ†é…è™šæ‹ŸIPï¼ˆéœ€ç¡®ä¿ä¸ä¸å®é™…ç§æœ‰IPå†²çªï¼‰
nebula-cert sign -name "ec2-a" -ip "192.168.100.1/24"
nebula-cert sign -name "ec2-b" -ip "192.168.100.2/24"
nebula-cert sign -name "ec2-c" -ip "192.168.100.3/24"
å…³é”®ç‚¹ï¼šè™šæ‹ŸIPï¼ˆå¦‚ 192.168.100.0/24ï¼‰ä¸å®é™…ç§æœ‰IPå®Œå…¨ç‹¬ç«‹ã€‚

2. EC2-B é…ç½®ï¼ˆä¸­ç»§èŠ‚ç‚¹ï¼‰
/etc/nebula/config.ymlï¼š

yaml
pki:
  ca: /etc/nebula/ca.crt
  cert: /etc/nebula/ec2-b.crt
  key: /etc/nebula/ec2-b.key

# ä½¿ç”¨ EC2 ç§æœ‰IPä½œä¸ºç›´è¿åœ°å€
static_host_map:
  "192.168.100.1": ["10.11.2.1:4242"]  # EC2-A
  "192.168.100.3": ["10.101.2.4:4242"] # EC2-C

listen:
  host: 0.0.0.0
  port: 4242

tun:
  dev: nebula1

firewall:
  inbound:
    - port: any
      proto: any
      host: any
  outbound:
    - port: any
      proto: any
      host: any
3. EC2-A é…ç½®ï¼ˆå®¢æˆ·ç«¯ï¼‰
/etc/nebula/config.ymlï¼š

yaml
pki:
  ca: /etc/nebula/ca.crt
  cert: /etc/nebula/ec2-a.crt
  key: /etc/nebula/ec2-a.key

static_host_map:
  "192.168.100.2": ["10.135.2.14:4242"]  # ä»…éœ€æŒ‡å‘EC2-B

lighthouse:
  am_lighthouse: false

tun:
  dev: nebula1
4. EC2-C é…ç½®ï¼ˆæœåŠ¡ç«¯ï¼‰
/etc/nebula/config.ymlï¼š

yaml
pki:
  ca: /etc/nebula/ca.crt
  cert: /etc/nebula/ec2-c.crt
  key: /etc/nebula/ec2-c.key

static_host_map:
  "192.168.100.2": ["10.135.2.14:4242"]  # ä»…éœ€æŒ‡å‘EC2-B

firewall:
  inbound:
    - port: 3128    # åªå¼€æ”¾3128ç«¯å£
      proto: tcp
      host: "192.168.100.2"  # ä»…å…è®¸EC2-Bçš„è™šæ‹ŸIPè®¿é—®
ä¸‰ã€æµé‡è½¬å‘é…ç½®ï¼ˆå…³é”®æ­¥éª¤ï¼‰
åœ¨ EC2-B ä¸Šå¯ç”¨ IP è½¬å‘å’Œ NATï¼š
bash
# å¯ç”¨å†…æ ¸è½¬å‘
echo 1 > /proc/sys/net/ipv4/ip_forward

# æ·»åŠ iptablesè§„åˆ™ï¼ˆå°†EC2-Açš„æµé‡è½¬å‘åˆ°EC2-Cï¼‰
iptables -t nat -A PREROUTING -p tcp -s 10.11.2.1 --dport 3128 -j DNAT --to-destination 10.101.2.4:3128
iptables -t nat -A POSTROUTING -p tcp -d 10.101.2.4 --dport 3128 -j SNAT --to-source 10.135.2.14
åœ¨ EC2-A ä¸Šæµ‹è¯•è¿æ¥ï¼š
bash
curl -x http://192.168.100.3:3128 http://example.com
æµé‡è·¯å¾„ï¼šEC2-A â†’ Nebulaéš§é“ â†’ EC2-B â†’ å®é™…ç½‘ç»œ â†’ EC2-C

å››ã€éªŒè¯ä¸è°ƒè¯•
æ£€æŸ¥ Nebula è¿æ¥çŠ¶æ€ï¼š

bash
nebula -test -config /etc/nebula/config.yml
æŸ¥çœ‹è·¯ç”±è¡¨ï¼š

bash
ip route show dev nebula1
æŠ“åŒ…åˆ†æï¼ˆåœ¨ EC2-B ä¸Šï¼‰ï¼š

bash
tcpdump -i any host 10.101.2.4 and port 3128
äº”ã€æœ€ç»ˆç½‘ç»œæµç¤ºæ„å›¾
text
EC2-A (192.168.100.1) 
  â”‚
  â†“ Nebulaéš§é“
EC2-B (192.168.100.2) â†’ å®é™…ç½‘ç»œ â†’ EC2-C (10.101.2.4:3128)
å¸¸è§é—®é¢˜è§£å†³
è¿æ¥è¶…æ—¶ï¼šæ£€æŸ¥ EC2-B çš„ iptables è§„åˆ™å’Œå†…æ ¸è½¬å‘æ˜¯å¦ç”Ÿæ•ˆã€‚

Nebula æ— æ³•å»ºç«‹éš§é“ï¼šç¡®è®¤æ‰€æœ‰èŠ‚ç‚¹çš„ static_host_map é…ç½®æ­£ç¡®ã€‚

æƒé™é—®é¢˜ï¼šç¡®ä¿ Nebula è¯ä¹¦æƒé™ä¸º 600ã€‚

å¦‚æœéœ€è¦æ›´è¯¦ç»†çš„é˜²ç«å¢™è§„åˆ™æˆ–æ€§èƒ½ä¼˜åŒ–ï¼Œå¯ä»¥è¿›ä¸€æ­¥è°ƒæ•´é…ç½®ï¼


===============================================

å¥½çš„ï¼Œæˆ‘å°†ä¸ºä½ ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ SlackHQ Nebula é…ç½®åŒ…ç¤ºä¾‹ç»“æ„ï¼ŒåŒ…æ‹¬ï¼š

âœ… è¯ä¹¦ç»“æ„ï¼ˆca, cert, keyï¼‰

âœ… å„æœºå™¨çš„ nebula.yml é…ç½®æ–‡ä»¶

âœ… æ–‡ä»¶ç›®å½•ç»“æ„ç¤ºæ„

ä½ å¯ä»¥åœ¨ä¸€å°ä¸»æœºä¸Šå…ˆç”Ÿæˆè¯ä¹¦å¹¶æ‰“åŒ…ï¼Œç„¶ååˆ†å‘åˆ°ä¸‰å° EC2 æœºå™¨ä¸Šã€‚

ğŸ—‚ï¸ é…ç½®åŒ…ç›®å½•ç»“æ„ï¼ˆç¤ºæ„ï¼‰
text
Copy
Edit
nebula-config/
â”œâ”€â”€ ca.crt
â”œâ”€â”€ ec2-a/
â”‚   â”œâ”€â”€ config.yml
â”‚   â”œâ”€â”€ cert.crt
â”‚   â”œâ”€â”€ cert.key
â”œâ”€â”€ ec2-b/
â”‚   â”œâ”€â”€ config.yml
â”‚   â”œâ”€â”€ cert.crt
â”‚   â”œâ”€â”€ cert.key
â”œâ”€â”€ ec2-c/
â”‚   â”œâ”€â”€ config.yml
â”‚   â”œâ”€â”€ cert.crt
â”‚   â”œâ”€â”€ cert.key
ğŸ› ï¸ æ­¥éª¤ 1ï¼šç”Ÿæˆ CA å’Œä¸»æœºè¯ä¹¦ï¼ˆä¸€æ¬¡æ€§ï¼‰
åœ¨æœ¬åœ°æˆ–ä»»æ„ä¸€å°æœºå™¨ä¸Šæ“ä½œï¼š

bash
Copy
Edit
# ä¸‹è½½å·¥å…·
wget https://github.com/slackhq/nebula/releases/download/v1.4.0/nebula-cert-linux-amd64
chmod +x nebula-cert-linux-amd64
mv nebula-cert-linux-amd64 nebula-cert

# åˆ›å»º CA
./nebula-cert ca -name "nebula-net"

# ä¸º EC2-Aï¼ˆNebula IP: 192.168.100.1ï¼‰
./nebula-cert sign -name "ec2-a" -ip "192.168.100.1/24" -groups "clients"

# ä¸º EC2-Bï¼ˆNebula IP: 192.168.100.2ï¼‰
./nebula-cert sign -name "ec2-b" -ip "192.168.100.2/24" -groups "relay,lighthouse"

# ä¸º EC2-Cï¼ˆNebula IP: 192.168.100.3ï¼‰
./nebula-cert sign -name "ec2-c" -ip "192.168.100.3/24" -groups "servers"
ğŸ“„ å„èŠ‚ç‚¹é…ç½®ï¼ˆconfig.ymlï¼‰
âœ… EC2-A (ec2-a/config.yml)
yaml
Copy
Edit
pki:
  ca: "../ca.crt"
  cert: "cert.crt"
  key: "cert.key"

lighthouse:
  am_lighthouse: false
  hosts:
    - "10.135.2.14:4242"

listen:
  host: 0.0.0.0
  port: 4242

static_host_map:
  "192.168.100.2": ["10.135.2.14:4242"]

relay:
  relays:
    - "192.168.100.2"

firewall:
  outbound:
    - port: any
      proto: any
      host: any
  inbound:
    - port: any
      proto: any
      host: any
âœ… EC2-B (ec2-b/config.yml)
yaml
Copy
Edit
pki:
  ca: "../ca.crt"
  cert: "cert.crt"
  key: "cert.key"

lighthouse:
  am_lighthouse: true
  interval: 60

listen:
  host: 0.0.0.0
  port: 4242

relay:
  am_relay: true

firewall:
  outbound:
    - port: any
      proto: any
      host: any
  inbound:
    - port: any
      proto: any
      host: any
âœ… EC2-C (ec2-c/config.yml)
yaml
Copy
Edit
pki:
  ca: "../ca.crt"
  cert: "cert.crt"
  key: "cert.key"

lighthouse:
  am_lighthouse: false
  hosts:
    - "10.135.2.14:4242"

listen:
  host: 0.0.0.0
  port: 4242

static_host_map:
  "192.168.100.2": ["10.135.2.14:4242"]

relay:
  can_relay: true

firewall:
  outbound:
    - port: any
      proto: any
      host: any
  inbound:
    - port: any
      proto: any
      host: any
ğŸš€ å¯åŠ¨æ–¹å¼ï¼ˆæ¯å° EC2ï¼‰
å°†å¯¹åº”çš„ç›®å½•å’Œ ca.crt æ‹·è´åˆ°æ¯å°æœºå™¨ï¼Œä¾‹å¦‚ï¼š

bash
Copy
Edit
scp -r nebula-config/ec2-a/* ec2-user@10.11.2.1:/etc/nebula/
scp nebula-config/ca.crt ec2-user@10.11.2.1:/etc/nebula/
ç„¶ååœ¨æ¯å°æœºå™¨ä¸Šè¿è¡Œï¼š

bash
Copy
Edit
./nebula -config /etc/nebula/config.yml &
ğŸ” æµ‹è¯•è¿æ¥
åœ¨ EC2-A ä¸Šï¼š

bash
Copy
Edit
curl http://192.168.100.3:3128
å¦‚æœ EC2-C ä¸Šçš„ 3128 æ­£åœ¨ç›‘å¬ï¼ˆå¦‚ Squid ä»£ç†ï¼‰ï¼Œä½ åº”è¯¥å¯ä»¥æˆåŠŸè®¿é—®ã€‚

ğŸ§± è¡¥å……å»ºè®®
å»ºè®®å°†é˜²ç«å¢™ï¼ˆå¦‚ AWS å®‰å…¨ç»„ï¼‰æ‰“å¼€ UDP 4242

å¯ä½¿ç”¨ systemd å¯åŠ¨ nebula ä¸ºæœåŠ¡

å¯å°† groups ç”¨äºè®¿é—®æ§åˆ¶
